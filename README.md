# Telegram Bot для проверки заявок в канал

Бот обрабатывает заявки на вступление в канал и работает по схеме:

1. Пользователь подает заявку в канал.
2. Бот автоматически пишет пользователю, что заявка получена.
3. Бот считает `risk score` (возраст по ID, username, имя, био, аватар).
4. Высокий риск отправляется на ручную проверку админам.
5. Средний риск получает усложненную image-captcha (больше символов и шума) с отдельным лимитом попыток.
6. Низкий риск получает стандартную image-captcha.
7. Пользователь вводит символы с картинки сообщением в чат боту.
8. После верной капчи бот автоматически одобряет заявку в канал.

## Важно

Telegram Bot API не отдает точную дату регистрации аккаунта.  
Поэтому в проекте используется **risk score**, где часть сигналов строится на оценке возраста аккаунта по диапазону `user_id`. Это эвристика, а не точное значение.

## Требования

- Python 3.10+
- Pillow (устанавливается из `requirements.txt`)
- Бот добавлен в канал как админ
- У бота есть право на работу с заявками (`invite users` / `manage join requests`)
- В канале включены заявки на вступление

## Установка

```bash
python -m venv .venv
pip install -r requirements.txt
```

Активация окружения:

- Windows (PowerShell): `.venv\Scripts\activate`
- Linux/macOS: `source .venv/bin/activate`

Скопируйте `.env.example` в `.env` и заполните значения:

- `BOT_TOKEN` - токен бота
- `CHANNEL_ID` - ID канала (обычно вида `-100...`)
- `ADMIN_IDS` - ID админов через запятую
- `DB_PATH` - путь к SQLite базе
- `MIN_ACCOUNT_AGE_DAYS` - порог "нового аккаунта"
- `MAX_CAPTCHA_ATTEMPTS` - число попыток на капчу
- `RISK_SCORE_TO_HARD_CAPTCHA` - порог риска для усложненной капчи
- `RISK_SCORE_TO_ADMIN` - порог риска для ручной проверки админом
- `HARD_CAPTCHA_ATTEMPTS` - число попыток для усложненной капчи

## Запуск

```bash
python main.py
```

## Деплой на VPS

Полная инструкция по деплою как `systemd`-сервиса и запуску без изменений существующего `nginx`:

- `VPS_DEPLOY.md`

## Как работает модерация

- Бот считает `risk score` по нескольким сигналам (эвристический возраст аккаунта, username, имя, био, аватар).
- Высокий риск: заявка уходит админам на ручную модерацию.
- Средний риск: бот выдает усложненную image-captcha (6 символов, повышенный шум) с отдельным лимитом попыток.
- Низкий риск: бот выдает image-captcha (5 символов).
- Пользователь отправляет ответ как обычное сообщение в чат с ботом.
- Верная капча: бот вызывает `approveChatJoinRequest`.
- Неверная капча после лимита попыток: бот вызывает `declineChatJoinRequest`.

## Команды админа

- `/admin` - интерактивная панель управления
- `/stats` - метрики за 24 часа
- `/pending` - список заявок на ручной разбор + кнопки действий
- `/channel` - статус канала, права бота и текущий режим модерации
